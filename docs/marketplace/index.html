<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baseline for Obsidian</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />

    <link rel="stylesheet" href="../main.css" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-38V3HD97K9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-38V3HD97K9");
    </script>
  </head>
  <body>
    <div class="header">
      <div class="header-title">
        <h1>
          <a href=".."><i data-lucide="chevron-left"></i>Baseline for Obsidian</a><span>/</span>
        </h1>
        <h1>Marketplace</h1>
      </div>
      <div class="header-actions">
        <a href="https://github.com/aaaaalexis/obsidian-baseline/blob/main/docs/marketplace/README.md" class="submit-btn">
          <button><i data-lucide="upload"></i>Submit</button>
        </a>
        <a href="https://github.com/aaaaalexis/obsidian-baseline" class="header-link">View Baseline on GitHub</a>
      </div>
    </div>
    <div class="content">
      <div class="setting-container" title='Click the "Import" button in Style Settings to import copied or downloaded style presets.'>
        <div class="setting">
          <div class="setting-sidebar">
            <div class="sidebar-section">
              <div class="sidebar-title">Community plugins</div>
              <div class="sidebar-link is-active">Style Settings</div>
            </div>
          </div>
          <div class="setting-content">
            <div class="setting-header">
              <div class="setting-search">
                <i data-lucide="search"></i>
                Search Style Settings...
              </div>
              <div class="setting-actions">
                <button>Import</button>
                <button>Export</button>
              </div>
            </div>
            <div class="setting-list">
              <div class="setting-item">
                <i data-lucide="chevron-right"></i>
                <div class="setting-item-name">Baseline</div>
                <div class="setting-item-actions"><i data-lucide="rotate-ccw"></i><i data-lucide="cloud-download"></i></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <p>Choose your favorite style preset, copy or download it, then import into Style Settings.</p>
      <div class="preset-actions">
        <input type="search" class="preset-search" placeholder="Search style presets..." />
        <button class="preset-filter"><i data-lucide="filter"></i>New to old</button>
      </div>
      <div class="panel-container"></div>
      <div class="lightbox-overlay" aria-hidden="true">
        <img class="lightbox-img" />
        <p class="lightbox-title"></p>
      </div>
    </div>

    <script src="https://unpkg.com/lucide@latest" onload="lucide.createIcons()"></script>
    <script>
      (() => {
        const fetchJSON = async (path) => {
          const r = await fetch(path);
          return r.ok ? r.json() : null;
        };
        const mdLinks = (t) => t.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');

        const pickSrc = (img) => {
          const { light, dark, base } = img.dataset;
          const darkPref = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          return darkPref ? dark || light || base : light || dark || base;
        };

        const loadAndReveal = (picture) => {
          const img = picture.querySelector("img");
          if (!img) return;
          const src = pickSrc(img);
          if (!src) return picture.classList.remove("loading");
          const loader = new Image();
          loader.onload = () => {
            img.src = src;
            requestAnimationFrame(() => picture.classList.remove("loading"));
          };
          loader.onerror = () => picture.classList.remove("loading");
          loader.src = src;
        };

        const loadPresets = async () => {
          const mainPreset = await fetchJSON("preset.json");
          if (!mainPreset) return;
          const presetDetails = {};

          const items = await Promise.all(
            Object.entries(mainPreset).map(async ([name, meta]) => {
              const presetFile = `${meta.id}.json`;
              const img = { light: `img/${meta.id}@light.png`, dark: `img/${meta.id}@dark.png`, base: `img/${meta.id}.png` };
              presetDetails[meta.id] = (await fetchJSON(`preset/${presetFile}`)) || {};
              const desc = meta.description ? mdLinks(meta.description) : "No description available.";
              const imageHTML = `<picture class="loading"><div class="preset-img-loader"></div><source data-srcset="${img.dark}" media="(prefers-color-scheme: dark)"><source data-srcset="${img.light}" media="(prefers-color-scheme: light)"><img loading="lazy" decoding="async" data-base="${img.base}" data-light="${img.light}" data-dark="${img.dark}"></picture>`;
              const authorHTML = meta.url ? `<a href="${meta.url}">${meta.author}</a>` : `${meta.author}`;
              const html = `<div class="preset-panel" data-preset="${meta.id}"><div class="preset-info"><h2>${name}</h2><p>By ${authorHTML}</p></div>${imageHTML}<p>${desc}</p><div class="panel-actions"><button class="copy-btn"><span><i data-lucide="copy"></i>Copy</span></button><a class="download-btn" href="preset/${presetFile}" download="baseline-${presetFile}"><button>Download</button></a></div></div>`;
              return { name, id: meta.id, meta, html, searchable: (name + " " + (meta.author || "") + " " + (meta.description || "")).toLowerCase() };
            })
          );

          const container = document.querySelector(".panel-container");
          const searchInput = document.querySelector(".preset-search");
          const filterBtn = document.querySelector(".preset-filter");

          const modes = ["new", "old", "a-z", "z-a"];
          let modeIndex = 0;

          const labelFor = (m) => ({ new: "New to old", old: "Old to new", "a-z": "A to Z", "z-a": "Z to A" }[m]);
          const updateFilterLabel = () => {
            filterBtn.innerHTML = `<i data-lucide="filter"></i>${labelFor(modes[modeIndex])}`;
            lucide.createIcons();
          };

          const render = () => {
            const q = (searchInput.value || "").trim().toLowerCase();
            let list = items.slice();
            const mode = modes[modeIndex];
            if (mode === "new") list = list.slice().reverse();
            else if (mode === "a-z") list.sort((a, b) => a.name.localeCompare(b.name));
            else if (mode === "z-a") list.sort((a, b) => b.name.localeCompare(a.name));

            if (q) list = list.filter((i) => i.searchable.includes(q));
            container.innerHTML = list.map((i) => i.html).join("");
            lucide.createIcons();
            container.querySelectorAll(".preset-panel picture").forEach(loadAndReveal);

            container.querySelectorAll(".copy-btn").forEach((btn, idx) => {
              const orig = btn.innerHTML;
              btn.onclick = () => {
                const presetId = container.querySelectorAll(".preset-panel")[idx].dataset.preset;
                const details = presetDetails[presetId];
                const meta = Object.values(mainPreset).find((m) => m.id === presetId);
                if (!details) return;
                navigator.clipboard.writeText(JSON.stringify(details, null, 2)).then(() => {
                  btn.innerHTML = "<span>Copied!</span>";
                  setTimeout(() => {
                    btn.innerHTML = orig;
                    lucide.createIcons();
                  }, 1000);
                  if (window.gtag && meta?.id) gtag("event", "preset_copy", { preset: meta.id });
                });
              };
            });

            container.querySelectorAll(".download-btn").forEach((dl, idx) =>
              dl.addEventListener("click", () => {
                const presetId = container.querySelectorAll(".preset-panel")[idx].dataset.preset;
                const meta = Object.values(mainPreset).find((m) => m.id === presetId);
                if (window.gtag && meta?.id) gtag("event", "preset_download", { preset: meta.id });
              })
            );
          };

          const params = new URLSearchParams(window.location.search);
          const q = params.get("q");
          if (q) searchInput.value = q;
          updateFilterLabel();
          let debounce;
          searchInput.addEventListener("input", () => {
            clearTimeout(debounce);
            debounce = setTimeout(() => {
              const val = searchInput.value.trim();
              const url = new URL(window.location);
              if (val) url.searchParams.set("q", val);
              else url.searchParams.delete("q");
              window.history.replaceState({}, "", url);
              render();
            }, 150);
          });
          filterBtn.addEventListener("click", () => {
            modeIndex = (modeIndex + 1) % modes.length;
            updateFilterLabel();
            render();
          });
          render();
        };
        loadPresets();
      })();
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const overlay = document.querySelector(".lightbox-overlay");
        if (!overlay) return;
        const lightboxImg = overlay.querySelector(".lightbox-img");
        const lightboxThemeName = overlay.querySelector(".lightbox-title");
        let hiddenHandler;

        let openedPicture = null;
        function openLightbox(src, picture) {
          overlay.classList.remove("hidden");
          if (hiddenHandler) lightboxImg.removeEventListener("transitionend", hiddenHandler);
          hiddenHandler = null;
          lightboxImg.src = src;
          overlay.classList.add("active");
          if (picture) {
            const panel = picture.closest(".preset-panel");
            if (panel) {
              const themeName = panel.querySelector("h2");
              lightboxThemeName.textContent = themeName ? themeName.textContent : "";
            } else {
              lightboxThemeName.textContent = "";
            }
            picture.classList.add("opened");
            openedPicture = picture;
          } else {
            lightboxThemeName.textContent = "";
            openedPicture = null;
          }
        }

        function closeLightbox() {
          if (!overlay.classList.contains("active")) return;
          overlay.classList.add("hidden");
          overlay.classList.remove("active");
          if (openedPicture) {
            openedPicture.classList.remove("opened");
            openedPicture = null;
          }
          if (hiddenHandler) lightboxImg.removeEventListener("transitionend", hiddenHandler);
          hiddenHandler = function handler() {
            overlay.classList.remove("hidden");
            lightboxImg.src = "";
            lightboxThemeName.textContent = "";
            lightboxImg.removeEventListener("transitionend", handler);
            hiddenHandler = null;
          };
          lightboxImg.addEventListener("transitionend", hiddenHandler);
        }

        document.addEventListener("click", function (e) {
          const picture = e.target.closest(".preset-panel picture");
          if (picture) {
            const img = picture.querySelector("img");
            if (img) {
              const lightSrc = img.getAttribute("data-light");
              const darkSrc = img.getAttribute("data-dark");
              let src = img.src;
              if (lightSrc || darkSrc) {
                const isDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
                src = isDark ? darkSrc || lightSrc : lightSrc || darkSrc;
              }
              return openLightbox(src, picture);
            }
          }
          if (e.target === overlay || e.target === lightboxImg) return closeLightbox();
        });
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && overlay.classList.contains("active")) closeLightbox();
        });
      });
    </script>
  </body>
</html>
